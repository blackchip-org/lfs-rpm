#!/bin/bash

set -e

prog="$(basename $0)"
cd "$(dirname $0)"

source ./env

usage() {
    cat <<EOF

Usage: $prog [specfile...]

EOF
    exit 2
}

pod-init() {
    set -x
    bash -c "source ./env ; env | grep -e '^lfs_'" > eval.env

    podman build --tag lfs-pod containers/lfs-pod
}

pod-build() {
    package=$(basename "$1" .spec)

    set -x

    podman stop -t 0    lfs-pod || true
    podman rm -f        lfs-pod || true

    mkdir -p        build/pod/rpms/x86_64
    mkdir -p        build/pod/srpms

    podman create \
        --name      lfs-pod \
        --hostname  lfs-pod \
        --env-file  eval.env \
        --userns    keep-id \
        --volume    "./build/sources:/build/rpmbuild/SOURCES:z" \
        --volume    "./build/pod/rpms:/build/rpmbuild/RPMS:z" \
        --volume    "./build/pod/srpms:/build/rpmbuild/SRPMS:z" \
        --volume    .:/build/lfs-rpm:z \
        lfs-pod

    podman start lfs-pod

    createrepo_c build/pod/rpms/x86_64

    rm -rf  build/deps
    mkdir   build/deps

    reqs=$(rpmspec -q --buildrequires $1)
    deps=$(dnf repoquery \
        --repofrompath pod,build/pod/rpms/x86_64 \
        --disablerepo='*' \
        --enablerepo=pod \
        --refresh \
        --requires \
        --resolve \
        $reqs)

    if [ -n "$reqs" ] ; then
        dnf download \
            --repofrompath pod,build/pod/rpms/x86_64 \
            --disablerepo='*' \
            --enablerepo=pod \
            --downloaddir build/deps\
            --refresh \
            $reqs $deps

        podman exec \
            --user root \
            lfs-pod \
            rpm -i --force --nodeps /build/lfs-rpm/build/deps/*.rpm
    fi

    podman exec \
        lfs-pod \
        rpmbuild -ba --nocheck \
            --define "_sourcedir /build/rpmbuild/SOURCES/$package" \
            lfs-rpm/$1

}

case $1 in
    init)
        pod-init
        ;;
    build)
        shift
        specs=$(cat $1)
        for arg in $specs; do
            echo -e "\n----- building pod:$arg"
            pod-build $arg
        done
        ;;
    rpm)
        shift
        for arg in $@ ; do
            pod-build $arg
        done
        ;;
    shell)
        exec podman exec -it lfs-pod /bin/bash
        ;;
    *)
        echo "$prog: error: invalid command" 1>&2
        usage
        ;;
esac

